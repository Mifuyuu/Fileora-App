<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="icon.png" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <title>Fileora - Upload</title>
  <style>
    :root {
      --background-color: #09090b;
      --text-color: #95959e;
      --icon-color: #fafafa;
      --container-bg: #1f1f23;
      --container-shadow: #0000009f 0px 5px 10px;
      --hover-color: #8a2be2;
      --border-color: #444;
      --input-bg: #2a2a2a;
      --success-color: #2aeb74;
      --error-color: #ff4d4d;
      --disabled-color: #555;
      --accent-color: #00bcd4;
    }

    body[data-theme="light"] {
      --background-color: #f4f4f5;
      --text-color: #52525b;
      --icon-color: #18181b;
      --container-bg: #ffffff;
      --container-shadow: #0000001a 0px 5px 10px;
      --border-color: #d1d5db;
      --input-bg: #f9fafb;
      --disabled-color: #9ca3af;
      --accent-color: #0891b2;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Roboto", sans-serif;
    }

    body {
      margin: 0;
      padding: 20px;
      background-color: var(--background-color);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
      text-align: center;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .container {
      background: var(--container-bg);
      padding: 25px;
      border-radius: 12px;
      width: 100%;
      max-width: 480px;
      box-shadow: var(--container-shadow);
      border: 1px solid var(--border-color);
    }

    h2 {
      margin-top: 0;
      color: var(--icon-color);
    }

    p {
      color: var(--text-color);
    }

    #fileInput {
      display: none;
    }

    #infoText {
      margin-bottom: 16px;
      margin-top: 16px;
    }

    .file-label {
      display: block;
      padding: 20px;
      border: 2px dashed var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 15px;
      transition: background 0.2s ease, border-color 0.2s ease;
    }

    .file-label:hover {
      background: var(--input-bg);
      border-color: var(--hover-color);
    }

    #fileName {
      display: block;
      margin-top: 10px;
      color: var(--accent-color);
      font-weight: bold;
      word-break: break-all;
    }

    button {
      font-size: 1rem;
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
      cursor: pointer;
      background: var(--hover-color);
      color: #fff;
      font-weight: bold;
      transition: background 0.3s ease;
    }

    button:hover:not(:disabled) {
      background: #a150ff;
    }

    button:disabled {
      background: var(--disabled-color);
      cursor: not-allowed;
    }

    #progressBar {
      width: 100%;
      height: 10px;
      background: var(--border-color);
      border-radius: 10px;
      overflow: hidden;
      margin-top: 15px;
      display: none;
    }

    #progressBar div {
      height: 100%;
      width: 0;
      background: var(--success-color);
      transition: width 0.3s ease;
    }

    #statusMessage {
      margin-top: 15px;
      font-weight: bold;
    }

    #usedSessionContainer {
      display: none;
    }

    #usedSessionContainer p {
      font-size: 1.2rem;
      color: var(--error-color);
      font-weight: bold;
    }
  </style>
</head>

<body data-theme="dark">
  <div class="container">
    <div id="uploadContainer">
      <h2>Upload File</h2>
      <p id="infoText">Select a file to send to your computer.</p>
      <input type="file" id="fileInput" />
      <label for="fileInput" class="file-label">
        <span>Click to select a file</span>
        <span id="fileName"></span>
      </label>
      <button id="btnUpload" disabled>Upload File</button>
      <div id="progressBar">
        <div></div>
      </div>
      <div id="statusMessage"></div>
    </div>
    <div id="usedSessionContainer">
      <p>This session has already been used. Please create a new session on your computer!</p>
    </div>
  </div>
  <script>
    const fileInput = document.getElementById('fileInput');
    const btnUpload = document.getElementById('btnUpload');
    const progressBar = document.getElementById('progressBar');
    const progressBarInner = progressBar.firstElementChild;
    const fileNameDisplay = document.getElementById('fileName');
    const statusMessage = document.getElementById('statusMessage');
    const uploadContainer = document.getElementById('uploadContainer');
    const usedSessionContainer = document.getElementById('usedSessionContainer');
    let sessionId = null;

    function showStatus(message, isError = false) {
      statusMessage.textContent = message;
      statusMessage.style.color = isError ? 'var(--error-color)' : 'var(--success-color)';
    }

    // Theme management - sync with main page
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'dark';
      document.body.setAttribute('data-theme', savedTheme);
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize theme first
      initTheme();
      
      // Check for session ID
      const urlParams = new URLSearchParams(window.location.search);
      sessionId = urlParams.get('sessionId');
      if (!sessionId) {
        document.getElementById('infoText').textContent = "Error: Invalid or missing session link.";
        fileInput.disabled = true;
        btnUpload.disabled = true;
      }
    });

    fileInput.addEventListener('change', () => {
      if (fileInput.files.length > 0) {
        fileNameDisplay.textContent = fileInput.files[0].name;
        btnUpload.disabled = false;
        showStatus('');
      } else {
        fileNameDisplay.textContent = '';
        btnUpload.disabled = true;
      }
    });

    btnUpload.addEventListener('click', async () => {
      if (!fileInput.files.length || !sessionId) return;
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('file', file);
      btnUpload.disabled = true;
      progressBar.style.display = 'block';
      progressBarInner.style.width = '0%';
      showStatus('Uploading...');

      const xhr = new XMLHttpRequest();
      xhr.open('POST', `/api/upload?sessionId=${sessionId}`, true);
      xhr.upload.onprogress = (event) => {
        if (event.lengthComputable) {
          const percent = (event.loaded / event.total) * 100;
          progressBarInner.style.width = percent.toFixed(2) + '%';
        }
      };
      xhr.onload = () => {
        progressBar.style.display = 'none';
        if (xhr.status === 200) {
          showStatus('âœ… Upload Successful! You can close this window.');
          setTimeout(() => window.close(), 3000);
        } else {
          try {
            const errorResponse = JSON.parse(xhr.responseText);
            showStatus(`Upload Failed: ${errorResponse.error || 'Server error'}`, true);
            if (xhr.status === 403) {
              uploadContainer.style.display = 'none';
              usedSessionContainer.style.display = 'block';
            } else {
              btnUpload.disabled = false;
            }
          } catch (e) {
            showStatus(`Upload Failed: An unknown error occurred.`, true);
            btnUpload.disabled = false;
          }
        }
      };
      xhr.onerror = () => {
        showStatus('An error occurred during the transfer.', true);
        btnUpload.disabled = false;
        progressBar.style.display = 'none';
      };
      xhr.send(formData);
    });
  </script>
</body>

</html>