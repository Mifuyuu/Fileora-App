<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fileora - Upload</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #121212;
      color: #eee;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .container {
      background: #1f1f1f;
      padding: 25px;
      border-radius: 12px;
      width: 100%;
      max-width: 480px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      text-align: center;
    }
    h2 {
      margin-top: 0;
      color: #fafafa;
    }
    p {
      color: #aaa;
    }
    #fileInput {
      display: none;
    }
    .file-label {
      display: block;
      padding: 12px 20px;
      border: 2px dashed #444;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 15px;
      transition: background 0.2s ease, border-color 0.2s ease;
    }
    .file-label:hover {
      background: #2a2a2a;
      border-color: #8a2be2;
    }
    #fileName {
      display: block;
      margin-top: 10px;
      color: #00bcd4;
      font-weight: bold;
      word-break: break-all;
    }
    button {
      font-size: 1rem;
      padding: 12px 20px;
      border-radius: 8px;
      border: none;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
      cursor: pointer;
      background: #8a2be2;
      color: #fff;
      font-weight: bold;
      transition: background 0.3s ease;
    }
    button:hover:not(:disabled) {
      background: #a150ff;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    #progressBar {
      width: 100%;
      height: 10px;
      background: #333;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 15px;
      display: none; /* ซ่อนไว้ก่อน */
    }
    #progressBar div {
      height: 100%;
      width: 0;
      background: #2aeb74;
      transition: width 0.3s ease;
    }
    #statusMessage {
        margin-top: 15px;
        font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Upload File</h2>
    <p id="infoText">Select a file to send it to your computer.</p>

    <!-- Input สำหรับเลือกไฟล์ (ซ่อนไว้ แต่ทำงานผ่าน label) -->
    <input type="file" id="fileInput" />
    
    <!-- Label ที่ทำให้สวยงามและกดเลือกไฟล์ได้ -->
    <label for="fileInput" class="file-label">
      <span>Click to select a file</span>
      <span id="fileName"></span>
    </label>

    <!-- ปุ่ม Upload -->
    <button id="btnUpload" disabled>Upload File</button>

    <!-- Progress Bar -->
    <div id="progressBar"><div></div></div>

    <!-- Status Message -->
    <div id="statusMessage"></div>
  </div>

  <script>
    // --- Element References ---
    const fileInput = document.getElementById('fileInput');
    const btnUpload = document.getElementById('btnUpload');
    const progressBar = document.getElementById('progressBar');
    const progressBarInner = progressBar.firstElementChild;
    const fileNameDisplay = document.getElementById('fileName');
    const infoText = document.getElementById('infoText');
    const statusMessage = document.getElementById('statusMessage');

    let sessionID = null;

    // --- Functions ---

    // ฟังก์ชันสำหรับแสดงข้อความสถานะ
    function showStatus(message, isError = false) {
        statusMessage.textContent = message;
        statusMessage.style.color = isError ? '#ff4d4d' : '#00bcd4';
    }

    // --- Main Logic ---

    // 1. ดึง sessionID จาก URL ทันทีที่หน้าเว็บโหลด
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      sessionID = urlParams.get('sessionID');

      if (!sessionID) {
        infoText.textContent = "Error: Invalid or missing session link.";
        infoText.style.color = 'red';
        fileInput.disabled = true;
        btnUpload.disabled = true;
      }
    });

    // 2. เมื่อมีการเลือกไฟล์
    fileInput.addEventListener('change', () => {
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        fileNameDisplay.textContent = file.name;
        btnUpload.disabled = false; // เปิดปุ่ม Upload
        showStatus(''); // ล้างข้อความสถานะเดิม
      } else {
        fileNameDisplay.textContent = '';
        btnUpload.disabled = true;
      }
    });

    // 3. เมื่อกดปุ่ม Upload
    btnUpload.addEventListener('click', async () => {
      if (!fileInput.files.length) {
        showStatus('Please select a file first.', true);
        return;
      }
      if (!sessionID) {
        showStatus('Invalid session. Please re-scan the QR code.', true);
        return;
      }
      
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('file', file);
      formData.append('sessionID', sessionID);

      btnUpload.disabled = true; // ปิดปุ่มระหว่างอัพโหลด
      progressBar.style.display = 'block';
      progressBarInner.style.width = '0%';
      showStatus('Uploading...');

      try {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `/api/upload?sessionID=${sessionID}`, true);

        // ติดตามความคืบหน้า
        xhr.upload.onprogress = (event) => {
          if (event.lengthComputable) {
            const percent = (event.loaded / event.total) * 100;
            progressBarInner.style.width = percent.toFixed(2) + '%';
          }
        };

        // เมื่ออัพโหลดเสร็จ
        xhr.onload = () => {
          progressBar.style.display = 'none';
          if (xhr.status === 200) {
            showStatus('Upload Successful! You can close this window.');
            fileInput.value = ''; // ล้างค่าไฟล์ที่เลือก
            fileNameDisplay.textContent = '';
          } else {
            const errorResponse = JSON.parse(xhr.responseText);
            showStatus(`Upload Failed: ${errorResponse.error || 'Server error'}`, true);
            btnUpload.disabled = false; // เปิดให้ลองใหม่
          }
        };

        // เมื่อเกิดข้อผิดพลาด
        xhr.onerror = () => {
            showStatus('An error occurred during the transfer.', true);
            btnUpload.disabled = false;
            progressBar.style.display = 'none';
        };

        xhr.send(formData);

      } catch (err) {
        showStatus('Upload error: ' + err.message, true);
        btnUpload.disabled = false;
        progressBar.style.display = 'none';
      }
    });
  </script>
</body>
</html>